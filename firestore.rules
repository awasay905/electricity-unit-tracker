rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isHouseOwner(houseId) {
      return get(/databases/$(database)/documents/houses/$(houseId)).data.ownerId == request.auth.uid;
    }

    function isHouseMember(houseId) {
      let userHouseId = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.houseId;
      return userHouseId != null && userHouseId == houseId;
    }

    // --- Users Collection ---
    // Anyone can look at anyone's user profile, but you can only change your own.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update, delete: if request.auth.uid == userId;
    }

    // --- Houses Collection ---
    // You can only interact with a house if you are a member of it.
    match /houses/{houseId} {
      allow read: if isHouseMember(houseId);

      // Only the house owner can update house details (like name or goal)
      // and they cannot change who the owner is.
      allow update: if isHouseOwner(houseId) && request.resource.data.ownerId == resource.data.ownerId;

      // Any authenticated user can create a new house.
      allow create: if request.auth.uid != null;

      // --- Readings Sub-collection ---
      // Members can read/create. Only owner can update/delete.
      match /readings/{readingId} {
        allow read, create: if isHouseMember(houseId);
        allow update, delete: if isHouseOwner(houseId) && resource.data.isBillingCycleStart != true;
      }
    }

    // --- Join Requests Collection ---
    // You can only create a request for yourself.
    // Only the house owner can see the requests for their house.
    match /joinRequests/{requestId} {
       allow create: if request.auth.uid == request.resource.data.requesterId;
       allow read: if get(/databases/$(database)/documents/houses/$(request.resource.data.houseId)).data.ownerId == request.auth.uid;
       // Requests are deleted by a backend process, not by users directly
       allow update, delete: return false;
    }
  }
}
